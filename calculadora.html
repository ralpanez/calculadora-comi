<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora Remitente â€“ â‚¬/kg con porte y comisiÃ³n</title>
<style>
  :root { --bg:#0f172a; --panel:#111827; --muted:#9aa3b2; --ink:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --line:#1f2937; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif; background:linear-gradient(160deg,#0b1220,#0a0f1a); color:var(--ink)}
  .wrap{max-width:1100px; margin:32px auto; padding:0 16px}
  .card{background:rgba(17,24,39,.8); border:1px solid var(--line); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
  header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px}
  header h1{font-size:20px; margin:0; font-weight:700}
  .muted{color:var(--muted); font-size:13px}
  .controls{display:flex; flex-wrap:wrap; gap:10px}
  label.small{display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--muted)}
  input[type="number"]{appearance:textfield}
  input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{appearance:none; margin:0}
  input,button{border-radius:10px; border:1px solid var(--line); padding:10px 12px; background:#0b1020; color:var(--ink)}
  input{min-width:120px}
  button{cursor:pointer}
  .btn{border-color:#334155}
  .btn-accent{background:var(--accent); color:#062910; border-color:#16a34a}
  .btn-ghost{background:transparent}
  .btn-danger{background:var(--danger); border-color:#b91c1c}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid var(--line)}
  thead th{position:sticky; top:0; background:#0f172a; z-index:1; font-weight:600; font-size:12px; color:#cbd5e1; padding:10px 8px; text-align:left; border-bottom:1px solid var(--line)}
  tbody td{padding:8px; border-bottom:1px solid #1e293b; vertical-align:middle; font-size:14px}
  tbody tr:hover{background:rgba(148,163,184,.06)}
  tfoot td{padding:12px 10px; background:#0a1222; border-top:1px solid var(--line); font-weight:600}
  .right{text-align:right}
  .mono{font-variant-numeric:tabular-nums; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .pill{display:inline-block; padding:.2rem .5rem; border-radius:999px; background:#0b1b33; border:1px solid #1f2f4a; font-size:12px; color:#a7b3c7}
  .grid{display:grid; gap:14px}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:860px){ .grid-2{grid-template-columns:1fr} table{font-size:13px} input{min-width:80px} }
  .note{margin-top:6px; font-size:12px; color:#94a3b8}
  .sum{display:flex; gap:14px; flex-wrap:wrap}
  .sum .box{flex:1 1 200px; background:#0b1326; border:1px solid var(--line); border-radius:12px; padding:12px}
  .sum h3{margin:0 0 6px 0; font-size:12px; color:#93c5fd; font-weight:600}
  .sum .val{font-size:18px; font-weight:700}
  .danger-link{color:#fca5a5; text-decoration:underline; cursor:pointer}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Calculadora de pago a remitente (porte + comisiÃ³n)</h1>
        <div class="muted">Introduce tus lÃ­neas (palets). Se descuenta el <b>porte</b> y tu <b>comisiÃ³n</b> para obtener el pago al remitente y el â‚¬/kg real.</div>
      </div>
      <div class="toolbar">
        <button class="btn btn-accent" id="addRowBtn">+ AÃ±adir lÃ­nea</button>
        <button class="btn" id="exportCsvBtn">Exportar CSV</button>
        <button class="btn btn-ghost" id="clearAllBtn">Limpiar todo</button>
      </div>
    </header>

    <div class="card" style="padding:14px; margin-bottom:14px;">
      <div class="grid grid-2">
        <div class="controls">
          <label class="small">
            ComisiÃ³n (%) por defecto
            <input type="number" id="defaultComision" step="0.01" min="0" max="100" value="12">
          </label>
          <label class="small">
            Porte fijo (â‚¬) por defecto
            <input type="number" id="defaultPorte" step="0.01" min="0" value="55">
          </label>
          <div class="note">Estos valores se aplican a nuevas lÃ­neas. Puedes cambiarlos por lÃ­nea.</div>
        </div>
        <div class="controls">
          <label class="small">
            Decimales â‚¬/kg
            <input type="number" id="decKg" min="2" max="6" value="4">
          </label>
          <label class="small">
            Decimales â‚¬ totales
            <input type="number" id="decâ‚¬" min="0" max="2" value="2">
          </label>
          <div class="note">La app guarda tus ajustes automÃ¡ticamente.</div>
        </div>
      </div>
    </div>

    <div class="card" style="overflow:auto;">
      <table id="tabla">
        <thead>
          <tr>
            <th>#</th>
            <th>DescripciÃ³n</th>
            <th class="right">Precio venta (â‚¬/kg)</th>
            <th class="right">Kilos</th>
            <th class="right">Porte (â‚¬)</th>
            <th class="right">ComisiÃ³n (%)</th>
            <th class="right">Total venta (â‚¬)</th>
            <th class="right">Tu comisiÃ³n (â‚¬)</th>
            <th class="right">Pago remitente (â‚¬)</th>
            <th class="right">â‚¬/kg remitente</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- filas dinÃ¡micas -->
        </tbody>
        <tfoot>
          <tr>
            <td colspan="6" class="right">Totales</td>
            <td class="right mono" id="tTotalVenta">0,00 â‚¬</td>
            <td class="right mono" id="tComision">0,00 â‚¬</td>
            <td class="right mono" id="tPagoRem">0,00 â‚¬</td>
            <td class="right mono" id="tAvgKg">0,0000 â‚¬/kg</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="sum" style="margin-top:14px;">
      <div class="box">
        <h3>Resumen</h3>
        <div class="val mono" id="sumResumen">â€”</div>
        <div class="note">Promedio ponderado â‚¬/kg remitente sobre todos los kilos.</div>
      </div>
      <div class="box">
        <h3>Costes de porte acumulados</h3>
        <div class="val mono" id="sumPorte">0,00 â‚¬</div>
        <div class="note">Suma de portes de todas las lÃ­neas.</div>
      </div>
      <div class="box">
        <h3>Tus comisiones totales</h3>
        <div class="val mono" id="sumComisiones">0,00 â‚¬</div>
        <div class="note">Ya calculadas sobre (venta âˆ’ porte).</div>
      </div>
    </div>

    <p class="note" style="margin-top:10px">
      FÃ³rmula por lÃ­nea: <span class="pill mono">pagoRem = (precioÂ·kg âˆ’ porte) Â· (1 âˆ’ comisiÃ³n%)</span>
      &nbsp;&middot;&nbsp;
      <span class="pill mono">â‚¬/kg remitente = pagoRem / kg</span>
    </p>
  </div>

<script>
(function(){
  const fmtâ‚¬ = (v, d=2)=> new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',minimumFractionDigits:d,maximumFractionDigits:d}).format((+v||0));
  const fmtKgâ‚¬ = (v, d=4)=> `${new Intl.NumberFormat('es-ES',{minimumFractionDigits:d,maximumFractionDigits:d}).format((+v||0))} â‚¬/kg`;

  const els = {
    tbody: document.getElementById('tbody'),
    tTotalVenta: document.getElementById('tTotalVenta'),
    tComision: document.getElementById('tComision'),
    tPagoRem: document.getElementById('tPagoRem'),
    tAvgKg: document.getElementById('tAvgKg'),
    sumResumen: document.getElementById('sumResumen'),
    sumPorte: document.getElementById('sumPorte'),
    sumComisiones: document.getElementById('sumComisiones'),
    addRowBtn: document.getElementById('addRowBtn'),
    exportCsvBtn: document.getElementById('exportCsvBtn'),
    clearAllBtn: document.getElementById('clearAllBtn'),
    defCom: document.getElementById('defaultComision'),
    defPorte: document.getElementById('defaultPorte'),
    decKg: document.getElementById('decKg'),
    decE: document.getElementById('decâ‚¬'),
    tabla: document.getElementById('tabla'),
  };

  // Persistencia simple
  const LS_KEY = 'calcRemitente.v1';
  const loadState = () => {
    try {
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch { return null; }
  };
  const saveState = () => {
    const rows = [...els.tbody.querySelectorAll('tr')].map(tr=>{
      const g = q=> tr.querySelector(q);
      return {
        desc: g('.desc').value || '',
        precio: +g('.precio').value || 0,
        kilos: +g('.kilos').value || 0,
        porte: +g('.porte').value || 0,
        com: +g('.com').value || 0,
      };
    });
    const st = {
      rows,
      defCom: +els.defCom.value || 0,
      defPorte: +els.defPorte.value || 0,
      decKg: +els.decKg.value || 4,
      decE: +els.decE.value || 2,
    };
    localStorage.setItem(LS_KEY, JSON.stringify(st));
  };

  function addRow(data={}){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono idx"></td>
      <td><input class="desc" placeholder="DescripciÃ³n (opcional)" /></td>
      <td class="right"><input type="number" step="0.0001" min="0" class="precio mono" /></td>
      <td class="right"><input type="number" step="0.01" min="0" class="kilos mono" /></td>
      <td class="right"><input type="number" step="0.01" min="0" class="porte mono" /></td>
      <td class="right"><input type="number" step="0.01" min="0" max="100" class="com mono" /></td>
      <td class="right mono totalVenta">â€”</td>
      <td class="right mono tuCom">â€”</td>
      <td class="right mono pagoRem">â€”</td>
      <td class="right mono eurKg">â€”</td>
      <td class="right"><button class="btn btn-danger del">ðŸ—‘</button></td>
    `;
    els.tbody.appendChild(tr);

    const set = (cls, val, fallback)=> tr.querySelector('.'+cls).value = (val ?? fallback);
    set('desc', data.desc ?? '', '');
    set('precio', data.precio, 0);
    set('kilos', data.kilos, 0);
    set('porte', data.porte, +els.defPorte.value || 55);
    set('com', data.com, +els.defCom.value || 12);

    tr.addEventListener('input', ()=> { computeRow(tr); computeTotals(); saveState(); });
    tr.querySelector('.del').addEventListener('click', ()=>{
      tr.remove(); renumber(); computeTotals(); saveState();
    });

    computeRow(tr);
    renumber();
    computeTotals();
    saveState();
  }

  function renumber(){
    [...els.tbody.querySelectorAll('tr')].forEach((tr,i)=>{
      tr.querySelector('.idx').textContent = i+1;
    });
  }

  function computeRow(tr){
    const g = q=> tr.querySelector(q);
    const precio = +g('.precio').value || 0;
    const kilos = +g('.kilos').value || 0;
    const porte = +g('.porte').value || 0;
    const comPct = (+g('.com').value || 0) / 100;

    const decE = +els.decE.value || 2;
    const decKg = +els.decKg.value || 4;

    const totalVenta = precio * kilos;
    const base = Math.max(totalVenta - porte, 0); // nunca negativo
    const tuCom = base * comPct;
    const pagoRem = Math.max(base - tuCom, 0);
    const eurKg = kilos > 0 ? pagoRem / kilos : 0;

    g('.totalVenta').textContent = fmtâ‚¬(totalVenta, decE);
    g('.tuCom').textContent = fmtâ‚¬(tuCom, decE);
    g('.pagoRem').textContent = fmtâ‚¬(pagoRem, decE);
    g('.eurKg').textContent = (kilos>0)? new Intl.NumberFormat('es-ES',{minimumFractionDigits:decKg,maximumFractionDigits:decKg}).format(eurKg) + ' â‚¬/kg' : 'â€”';
  }

  function computeTotals(){
    const rows = [...els.tbody.querySelectorAll('tr')];

    const decE = +els.decE.value || 2;
    const decKg = +els.decKg.value || 4;

    let totalVenta=0, totalPorte=0, totalCom=0, totalPagoRem=0, totalKilos=0;

    rows.forEach(tr=>{
      const precio = +tr.querySelector('.precio').value || 0;
      const kilos  = +tr.querySelector('.kilos').value || 0;
      const porte  = +tr.querySelector('.porte').value || 0;
      const comPct = (+tr.querySelector('.com').value || 0)/100;

      const venta = precio*kilos;
      const base = Math.max(venta-porte,0);
      const com = base*comPct;
      const pago = Math.max(base-com,0);

      totalVenta += venta;
      totalPorte += porte;
      totalCom   += com;
      totalPagoRem += pago;
      totalKilos += kilos;
    });

    const avgKg = totalKilos>0 ? totalPagoRem/totalKilos : 0;

    els.tTotalVenta.textContent = fmtâ‚¬(totalVenta, decE);
    els.tComision.textContent   = fmtâ‚¬(totalCom, decE);
    els.tPagoRem.textContent    = fmtâ‚¬(totalPagoRem, decE);
    els.tAvgKg.textContent      = fmtKgâ‚¬(avgKg, decKg);

    els.sumResumen.textContent  = `${fmtKgâ‚¬(avgKg, decKg)} Â· ${new Intl.NumberFormat('es-ES').format(totalKilos)} kg`;
    els.sumPorte.textContent    = fmtâ‚¬(totalPorte, decE);
    els.sumComisiones.textContent = fmtâ‚¬(totalCom, decE);
  }

  // Export CSV
  function exportCSV(){
    const header = ['#','DescripciÃ³n','Precio â‚¬/kg','Kilos','Porte â‚¬','ComisiÃ³n %','Total venta â‚¬','Tu comisiÃ³n â‚¬','Pago remitente â‚¬','â‚¬/kg remitente'];
    const rows = [...els.tbody.querySelectorAll('tr')].map((tr,i)=>{
      const getText = cls => tr.querySelector('.'+cls)?.textContent?.replace(/\s*â‚¬\/kg|\s*â‚¬/g,'').replace(/\./g,'').replace(',', '.') ?? '';
      const precio = tr.querySelector('.precio').value;
      const kilos  = tr.querySelector('.kilos').value;
      const porte  = tr.querySelector('.porte').value;
      const com    = tr.querySelector('.com').value;
      const totalVenta = getText('totalVenta');
      const tuCom = getText('tuCom');
      const pagoRem = getText('pagoRem');
      const eurKg = getText('eurKg');
      const desc = tr.querySelector('.desc').value.replace(/"/g,'""');
      return [i+1, `"${desc}"`, precio, kilos, porte, com, totalVenta, tuCom, pagoRem, eurKg];
    });
    const totals = [
      '', 'TOTALES','','','',
      '',
      els.tTotalVenta.textContent.replace(/\./g,'').replace(',','.').replace(' â‚¬',''),
      els.tComision.textContent.replace(/\./g,'').replace(',','.').replace(' â‚¬',''),
      els.tPagoRem.textContent.replace(/\./g,'').replace(',','.').replace(' â‚¬',''),
      els.tAvgKg.textContent.replace(/\./g,'').replace(',','.').replace(' â‚¬/kg',''),
    ];
    const csv = [header, ...rows, totals].map(r=>r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:'remitentes.csv'});
    document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }

  // Limpiar todo
  function clearAll(){
    if(!confirm('Â¿Vaciar todas las lÃ­neas y ajustes guardados?')) return;
    els.tbody.innerHTML = '';
    addRow(); // deja una lÃ­nea vacÃ­a por comodidad
    computeTotals();
    localStorage.removeItem(LS_KEY);
  }

  // Eventos globales
  els.addRowBtn.addEventListener('click', ()=> addRow());
  els.exportCsvBtn.addEventListener('click', exportCSV);
  els.clearAllBtn.addEventListener('click', clearAll);

  [els.defCom, els.defPorte, els.decKg, els.decE].forEach(inp=>{
    inp.addEventListener('input', ()=>{
      // Reaplicar formato y/o defaults a filas vacÃ­as de forma no intrusiva
      [...els.tbody.querySelectorAll('tr')].forEach(tr=> computeRow(tr));
      computeTotals(); saveState();
    });
  });

  // Inicializar
  const state = loadState();
  if(state){
    els.defCom.value = state.defCom ?? 12;
    els.defPorte.value = state.defPorte ?? 55;
    els.decKg.value = state.decKg ?? 4;
    els.decE.value = state.decE ?? 2;
    (state.rows && state.rows.length ? state.rows : [{}]).forEach(r => addRow(r));
  } else {
    addRow({ precio: 1.00, kilos: 500, porte: 55, com: 12, desc: 'Ejemplo' });
  }
})();
</script>
</body>
</html>
